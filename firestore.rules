rules_version = '2';

// ──────────────────────────────────────────────────────────────────────────────
// Firestore Security Rules — Dynamic Role-Based Access Control
//
// Roles are stored in /roles/{roleId} with a permissions map.
// Each user has a document at /users/{uid} with a roleId field + isActive flag.
//
// Helper functions resolve the user's role and check permissions dynamically.
// ──────────────────────────────────────────────────────────────────────────────

service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper Functions ───────────────────────────────────────────────────

    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isActiveUser() {
      return isAuthenticated() && getUserDoc().isActive == true;
    }

    function getUserRoleId() {
      return getUserDoc().roleId;
    }

    function getRoleDoc() {
      return get(/databases/$(database)/documents/roles/$(getUserRoleId())).data;
    }

    function hasPermission(perm) {
      return isActiveUser() && getRoleDoc().permissions[perm] == true;
    }

    function isAdmin() {
      return hasPermission('roles.manage');
    }

    // ── Roles Collection ───────────────────────────────────────────────────
    // Only admin can write. All active authenticated users can read.

    // ── Roles Collection ───────────────────────────────────────────────────
    // Read is open (needed during setup + role resolution).
    // Only admin can write.

    match /roles/{roleId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // ── Users Collection ───────────────────────────────────────────────────
    // List/read is open so the login page can detect "first-time setup".
    // Only authenticated users can create their own doc.
    // Only admin can manage (create for others, update, delete) users.

    match /users/{userId} {
      allow read: if true;

      allow create: if isAuthenticated()
        && (request.auth.uid == userId || isAdmin());

      allow update: if isAuthenticated()
        && (request.auth.uid == userId || isAdmin());

      allow delete: if isAdmin();
    }

    // ── Products Collection ───────────────────────────────────────────────
    match /products/{docId} {
      allow read: if isActiveUser() && hasPermission('products.view');
      allow create: if hasPermission('products.create');
      allow update: if hasPermission('products.edit');
      allow delete: if isAdmin();
    }

    // ── Production Lines Collection ───────────────────────────────────────
    match /production_lines/{docId} {
      allow read: if isActiveUser() && hasPermission('lines.view');
      allow create: if hasPermission('lines.create');
      allow update: if hasPermission('lines.edit');
      allow delete: if isAdmin();
    }

    // ── Supervisors Collection ────────────────────────────────────────────
    match /supervisors/{docId} {
      allow read: if isActiveUser() && hasPermission('supervisors.view');
      allow create: if hasPermission('supervisors.create');
      allow update: if hasPermission('supervisors.edit');
      allow delete: if isAdmin();
    }

    // ── Production Reports Collection ─────────────────────────────────────
    // Only admin can delete. Only hall supervisor+ can edit.
    match /production_reports/{docId} {
      allow read: if isActiveUser() && hasPermission('reports.view');
      allow create: if hasPermission('reports.create');
      allow update: if hasPermission('reports.edit');
      allow delete: if isAdmin();
    }

    // ── Line Status Collection ────────────────────────────────────────────
    match /line_status/{docId} {
      allow read: if isActiveUser() && hasPermission('lineStatus.view');
      allow create, update: if hasPermission('lineStatus.edit');
      allow delete: if isAdmin();
    }

    // ── Line Product Config Collection ────────────────────────────────────
    match /line_product_config/{docId} {
      allow read: if isActiveUser() && hasPermission('lineProductConfig.view');
      allow create, update, delete: if isAdmin();
    }

    // ── Activity Logs Collection ──────────────────────────────────────────
    // Any active user can create logs. Only admin can read/delete.
    match /activity_logs/{docId} {
      allow read: if hasPermission('activityLog.view');
      allow create: if isActiveUser();
      allow update, delete: if isAdmin();
    }

    // ── Catch-all: deny everything else ───────────────────────────────────
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
